name: Multi-Branch Remote Deployment

on:
  push:
    branches:
      - main
      - staging
      - dev

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Deploy Based on Branch
        env:
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          echo "$SSH_KEY" > key.pem
          chmod 600 key.pem

          # Determine target directory based on branch
          if [ "${{ github.ref_name }}" == "main" ]; then
            TARGET_DIR="/var/www/Travel-Blog-App"
            BRANCH="main"
          elif [ "${{ github.ref_name }}" == "staging" ]; then
            TARGET_DIR="/var/www/staging"
            BRANCH="staging"
          elif [ "${{ github.ref_name }}" == "dev" ]; then
            TARGET_DIR="/var/www/dev"
            BRANCH="dev"
          fi

          echo "ðŸš€ Deploying branch '$BRANCH' to $TARGET_DIR"

          ssh -i key.pem -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST << EOF
            set -e
            echo "ðŸ”¹ Switching to directory: $TARGET_DIR"
            cd $TARGET_DIR

            echo "ðŸ”¹ Pulling latest code from branch: $BRANCH"
            git fetch origin $BRANCH
            git checkout $BRANCH
            git pull origin $BRANCH

            echo "ðŸ”¹ Installing dependencies..."
            npm install --legacy-peer-deps

            echo "ðŸ”¹ Building production files..."
            npm run build

            echo "ðŸ”¹ Reloading Apache to apply changes..."
            sudo systemctl reload apache2

            echo "âœ… Deployment complete for $BRANCH"
          EOF
