name: Multi-Branch React App Deployment to Ubuntu Server

on:
  push:
    branches:
      - main
      - staging
      - dev

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to Ubuntu server
        env:
          PRIVATE_KEY: ${{ secrets.SSH_KEY }}
          HOST_NAME: ${{ secrets.HOST_NAME }}
          USER_NAME: ${{ secrets.USER_NAME }}
        run: |
          echo "$PRIVATE_KEY" > private_key
          chmod 600 private_key

          # Determine target directory based on branch name
          if [ "${{ github.ref_name }}" == "main" ]; then
            TARGET_DIR="/var/www/Travel-Blog-App"
          elif [ "${{ github.ref_name }}" == "staging" ]; then
            TARGET_DIR="/var/www/staging"
          elif [ "${{ github.ref_name }}" == "dev" ]; then
            TARGET_DIR="/var/www/dev"
          fi

          echo "ðŸš€ Deploying '${{ github.ref_name }}' branch to $TARGET_DIR"

          ssh -o StrictHostKeyChecking=no -i private_key ${USER_NAME}@${HOST_NAME} "
            cd $TARGET_DIR &&
            sudo git pull origin ${{ github.ref_name }} &&
            sudo npm install &&
            sudo npm run build &&
            sudo systemctl reload apache2
          "
