name: Multi-Environment React App Deployment

on:
  push:
    branches:
      - main
      - staging
      - dev

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üöÄ Deploy React App to Ubuntu Server
        env:
          PRIVATE_KEY: ${{ secrets.SSH_KEY }}
          HOST_NAME: ${{ secrets.HOST_NAME }}
          USER_NAME: ${{ secrets.USER_NAME }}
        run: |
          echo "$PRIVATE_KEY" > private_key
          chmod 600 private_key

          # Detect branch
          BRANCH_NAME="${GITHUB_REF##*/}"

          # Decide target directory based on branch
          if [ "$BRANCH_NAME" = "main" ]; then
            TARGET_DIR="/var/www/Travel-Blog-App"
          elif [ "$BRANCH_NAME" = "staging" ]; then
            TARGET_DIR="/var/www/Travel-Blog-Staging"
          elif [ "$BRANCH_NAME" = "dev" ]; then
            TARGET_DIR="/var/www/Travel-Blog-Dev"
          else
            echo "‚ùå Unknown branch: $BRANCH_NAME"
            exit 1
          fi

          echo "üì¶ Deploying branch '$BRANCH_NAME' to $TARGET_DIR on $HOST_NAME"

          ssh -o StrictHostKeyChecking=no -i private_key ${USER_NAME}@${HOST_NAME} <<EOF
            set -e
            echo "‚û°Ô∏è Connected to server."
            if [ ! -d "$TARGET_DIR" ]; then
              echo "‚ùå Target directory does not exist: $TARGET_DIR"
              exit 1
            fi
            cd $TARGET_DIR
            echo "üìç Inside: \$(pwd)"
            echo "Fix for dubious ownership"
            git config --global --add safe.directory $TARGET_DIR
            echo "üîÑ Pulling latest code..."
            git pull origin $BRANCH_NAME
            echo "üì¶ Installing dependencies..."
            npm install --silent
            echo "üèóÔ∏è Building project..."
            npm run build --silent
            echo "üîÅ Reloading Apache..."
            sudo systemctl reload apache2
            echo "‚úÖ Deployment complete for $BRANCH_NAME!"
          EOF
